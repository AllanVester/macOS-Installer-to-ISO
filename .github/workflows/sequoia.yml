name: Build macOS Sequoia ISO (24A335)

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free up disk space (Attempt)
        run: |
          # This helps slightly on standard runners, but usually isn't enough for this task
          sudo rm -rf /Users/runner/Library/Android/sdk
          sudo rm -rf /Library/Developer/CommandLineTools
          df -h

      - name: Download macOS Sequoia Installer
        run: |
          echo "Downloading InstallAssistant.pkg..."
          # Link from your previous message (verify the link is still active/valid)
          curl -L -o InstallAssistant.pkg "https://archive.org/download/macOS-24A335-InstallAssistant/InstallAssistant.pkg"

      - name: Install the Installer App
        run: |
          echo "Installing package..."
          sudo installer -pkg InstallAssistant.pkg -target /
          
          # Verify it exists
          ls -d /Applications/Install\ macOS\ Sequoia*.app
          
          # Delete the pkg to save space immediately
          rm InstallAssistant.pkg

      - name: Create and Mount Disk Image
        run: |
          echo "Creating empty disk image..."
          # Use a sparse image to save space until it's filled
          hdiutil create -o /tmp/Sequoia -size 18432m -volname Sequoia -layout SPUD -fs HFS+J
          
          echo "Mounting disk image..."
          hdiutil attach /tmp/Sequoia.dmg -noverify -mountpoint /Volumes/Sequoia

      - name: Create Install Media
        run: |
          echo "Running createinstallmedia (this takes time)..."
          # We use a wildcard (*) because the app name might vary slightly (e.g. "beta")
          INSTALLER_PATH=$(find /Applications -name "Install macOS Sequoia*.app" -maxdepth 1 | head -n 1)
          echo "Found installer at: $INSTALLER_PATH"
          
          sudo "$INSTALLER_PATH/Contents/Resources/createinstallmedia" --volume /Volumes/Sequoia --nointeraction

      - name: Unmount and Convert to ISO
        run: |
          echo "Unmounting..."
          hdiutil detach /Volumes/Install\ macOS\ Sequoia*
          
          echo "Converting to ISO/CDR..."
          hdiutil convert /tmp/Sequoia.dmg -format UDTO -o ./Sequoia.cdr
          
          echo "Renaming to .iso..."
          mv ./Sequoia.cdr ./Sequoia.iso
          
          ls -lh ./Sequoia.iso

      - name: Split ISO into 500MB chunks
        run: |
          # Create the destination directory
          mkdir -p ./split
          # Split the 18GB ISO into 500MB parts named Sequoia.iso.001, .002, etc.
          split -b 500m -d ./Sequoia.iso ./split/Sequoia.iso.
