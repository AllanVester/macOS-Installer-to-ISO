name: Build Mac OS X Lion ISO (10.7)

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: macos-15-intel
    timeout-minutes: 360
    steps:
      - name: Download Lion Disk Image
        run: |
          curl -L -o InstallMacOSX.dmg "https://updates.cdn-apple.com/2021/macos/041-7683-20210614-E610947E-C7CE-46EB-8860-D26D71F0D3EA/InstallMacOSX.dmg"

      - name: Install the Lion App
        run: |
          echo "Mounting DMG..."
          hdiutil attach InstallMacOSX.dmg -nobrowse -mountpoint /Volumes/InstallLion
          
          echo "Installing Package..."
          sudo installer -pkg /Volumes/InstallLion/InstallMacOSX.pkg -target /
          
          echo "Unmounting..."
          hdiutil detach /Volumes/InstallLion

      - name: Extract and Convert InstallESD
        run: |
          # Find the app using a wildcard to be safe
          LION_APP=$(find /Applications -name "Install Mac OS X Lion.app" -maxdepth 1 | head -n 1)
          echo "Found App at: $LION_APP"
          
          # For Lion, the "InstallESD.dmg" inside the app IS the bootable media.
          # We just need to copy it out.
          echo "Copying InstallESD.dmg..."
          cp "$LION_APP/Contents/SharedSupport/InstallESD.dmg" ./Lion.dmg
          
          echo "Converting to ISO..."
          hdiutil convert ./Lion.dmg -format UDTO -o ./Lion.cdr
          
          mv ./Lion.cdr ./Lion.iso
          
          ls -lh ./Lion.iso
          
      - name: Split ISO into 500MB chunks
        run: |
          # Create the destination directory
          mkdir -p ./split
          # Split the ISO into 500MB parts named Lion.iso.001, .002, etc.
          split -b 500m -d ./Lion.iso ./split/Lion.iso.
